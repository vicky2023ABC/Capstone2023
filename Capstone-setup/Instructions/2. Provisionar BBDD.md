## Paso 1. Provisionar una base de datos Amazon Aurora Serverless

Ve a la sección de RDS en la Consola de Gestión de AWS y elige Crear base de datos.

![Create database](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/2c7b5656-edc9-44c7-9ce1-42aaa8feae31)

En la casilla Elegir un método de creación de base de datos, elige Creación estándar.


![Standard create](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/eb096e90-c9d4-4d52-bc7c-d4d2ba430236)


En la casilla Opciones del motor, para Tipo de motor, elige Amazon Aurora.

Para Edición, elige Amazon Aurora con compatibilidad con PostgreSQL, en su versión 13.9 que es la mas actual compatible con serverless v1.

![3](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/43b7d785-1c96-4cd5-9861-f53c406a683f)


En la casilla Características de la base de datos, elige Serverless. Esta opción te permite utilizar la API de datos.

![5](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/f9e3e1c3-b2f1-4239-900a-8ec1ccbacf76)


En la casilla Configuración, cambia el nombre de la base de datos a "inventory".

Luego, ingresa una contraseña y confírmala en las casillas respectivas. Asegúrate de guardar esta contraseña, ya que la necesitarás para conectarte a tu base de datos. La casilla Configuración de capacidad establece la configuración para qué tan lejos escala hacia arriba y hacia abajo tu instancia de Amazon Aurora Serverless. Por defecto, está configurada para escalar hasta la capacidad máxima. Como estás haciendo pruebas, establece el valor máximo en 2 unidades de capacidad para limitar posibles cargos.

![6](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/7ec18572-9dd4-4458-b47e-56d7dd91ddfe)


En la casilla Conectividad, elige Configuración adicional de conectividad y luego selecciona la casilla de verificación de la API de datos.

![7](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/15594212-c9f8-40f3-921c-2b5c1b748caf)


Finalmente, elige Configuración adicional y desmarca la casilla de Protección contra eliminación. Desmarcar esta opción facilita la limpieza de tu base de datos al finalizar este laboratorio. Sin embargo, en entornos de producción, mantén la protección contra eliminación activada para evitar pérdidas accidentales de tu base de datos.

![8](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/06a390c5-284a-4275-980c-25a35c9cc342)


¡Estás listo para crear tu base de datos! Elige Crear base de datos para comenzar a aprovisionar tu base de datos.

Mientras tu base de datos se está aprovisionando, puedes almacenar las credenciales de tu base de datos en AWS Secrets Manager.

![9](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/fba0bde7-fb5c-45e3-b82d-a772872bf52f)

## Paso 2. Almacena tus credenciales de base de datos en AWS Secrets Manager

Cuando utilices la API de Datos con Amazon Aurora Serverless, tus credenciales de base de datos se almacenarán en AWS Secrets Manager. AWS Secrets Manager es un servicio completamente gestionado para gestionar fácilmente las claves de tu aplicación.

Para empezar, dirígete a la sección Secrets Manager de tu Consola de Gestión de AWS y elige "Store a new secret" (Almacenar un nuevo secreto).

En la casilla "Select secret type" (Seleccionar tipo de secreto), elige "Credentials for RDS database" (Credenciales para base de datos RDS). Luego, escribe el nombre de usuario y la contraseña que utilizaste al crear tu base de datos.

![10](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/43a36506-a044-475a-a5e4-de82d314a7e5)


En la sección "Select which RDS database this secret will access" (Seleccionar a qué base de datos RDS accederá este secreto), elige la base de datos de inventario que creaste y luego elige "Next" (Siguiente).

![11](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/f25921c8-77da-40cb-b105-f25615ef6107)


En la sección "Secret name and description" (Nombre y descripción del secreto), asigna un nombre y una descripción a tu secreto para que puedas encontrarlo fácilmente más tarde. Luego, elige "Next" (Siguiente).

![12](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/9618a0d4-87cb-4256-be42-041669996a60)


AWS Secrets Manager te permite configurar la rotación automática de secretos. Esta es una forma inteligente y sencilla de mejorar la seguridad de tu aplicación. Para obtener más información, consulta "Rotating Your AWS Secrets Manager Secrets" (Rotar tus secretos de AWS Secrets Manager).

Configurar la rotación de secretos está fuera del alcance de este tutorial, así que elige la opción "Disable automatic rotation" (Desactivar rotación automática) y luego elige "Next" (Siguiente).

![13](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/afa1c6e2-7b05-41ac-a34e-4a4e62f52acb)


La consola de Secrets Manager te muestra la configuración de tu secreto y un código de ejemplo que demuestra cómo usar tu secreto. Desplázate hasta la parte inferior de la página y elige "Store" (Guardar) para guardar tu secreto.

Después de crear el secreto, la página de Secrets Manager mostrará tus secretos creados. Elige tu secreto de la base de datos de inventario.

En la casilla "Secret details" (Detalles del secreto), se mostrará el ARN de tu secreto. Copia este valor, ya que lo necesitarás más adelante en este tutorial.

![14](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/9c7ccb4e-685a-4115-9d4f-1920f2049a36)


En este paso, has guardado las credenciales de tu base de datos en AWS Secrets Manager. En el próximo paso, aprenderás cómo usar tu secreto almacenado para acceder a tu base de datos con la API de Datos.

## Paso 3. Conéctate a tu base de datos con la API de Datos

Ahora que has provisionado tu base de datos y almacenado los secretos, intentemos acceder a tu base de datos con la API de Datos.

Primero, necesitas obtener los ARN de tus recursos. Dirígete a la sección RDS de la Consola de Gestión de AWS, elige "Databases" (Bases de datos) y luego selecciona tu base de datos de inventario.

Selecciona la pestaña "Configuration" (Configuración) y luego copia el valor ARN de tu base de datos.

![15](https://github.com/vicky2023ABC/Capstone2023/assets/150178798/a71b8800-1dc7-4c4b-b18f-9d869d31b180)


En este punto, deberías tener el ARN de tu base de datos de las instrucciones anteriores y el ARN de tu secreto al final del Paso 2. Utilizarás estos valores para acceder a tu base de datos.
Dirígete a la terminal en tu instancia de AWS Cloud9. Ingresa los siguientes comandos para establecer tus valores ARN como variables de entorno.

Asegúrate de sustituir tus valores ARN por tuDatabaseArn y tuSecretArn.
```bash
echo "export DATABASE_ARN=<tuDatabaseArn>" >> env.sh
echo "export SECRET_ARN=<tuSecretArn>" >> env.sh
source env.sh
```

En el directorio scripts/, hay un archivo testDatabase.js que puedes usar para probar tu conexión. El contenido de ese archivo es el siguiente:
```javascript
const AWS = require('aws-sdk')

const rdsdataservice = new AWS.RDSDataService();

const params = {
  resourceArn: process.env.DATABASE_ARN,
  secretArn: process.env.SECRET_ARN,
  sql: 'SELECT 1'
}

rdsdataservice.executeStatement(params, function(err, data) {
  if (err) {
    console.log(err, err.stack)
  } else {
    console.log(JSON.stringify(data, null, 2))
  }
})
```

En este script, construyes un cliente RDSDataService del SDK de AWS. Luego, configuras los parámetros del método, incluido resourceArn, nuestro secretArn y el SQL que deseas ejecutar. Este ejemplo utiliza una simple declaración SQL de SELECT 1 para demostrar que puedes conectarte.
Ejecuta el script en tu terminal de AWS Cloud9 con el siguiente comando:
```bash
node scripts/testDatabase.js
```

Deberías ver la siguiente salida en tu terminal:
```json
{
  "numberOfRecordsUpdated": 0,
  "records": [
    [
      {
        "longValue": 1
      }
    ]
  ]
}
```

¡Éxito! Recibiste el valor de 1 en tu único registro devuelto. Esto muestra que pudiste conectarte a tu base de datos con éxito.

Nota: Si aparece un mensaje de error indicando BadRequestException: FATAL: password authentication failed for user, puede indicar que configuraste tu secreto de AWS Secrets Manager incorrectamente. Vuelve a la consola de Secrets Manager y confirma el nombre de usuario y la contraseña que ingresaste.



